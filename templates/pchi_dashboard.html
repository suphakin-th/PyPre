<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCHI Claims Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f3f4f6;
            color: #1f2937;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
        }

        .header-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: #667eea;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 40px;
        }

        /* Filters */
        .filters-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .filters-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .filter-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #4b5563;
        }

        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .kpi-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .kpi-change {
            font-size: 12px;
            color: #10b981;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid #f3f4f6;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: #6b7280;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination button {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>üìä PCHI Claims Dashboard</h1>
            <div class="header-buttons">
                <button class="btn btn-primary" onclick="window.location.href='/dashboard'">‚Üê Back to Main</button>
                <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-title">üîç Filters</div>
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Year</label>
                    <select id="yearFilter" multiple size="3">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Claim Status</label>
                    <select id="statusFilter" multiple size="3">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Business Unit</label>
                    <select id="buFilter" multiple size="3">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Product</label>
                    <select id="productFilter" multiple size="3">
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div id="kpis-container" class="kpi-grid">
            <div class="loading">Loading KPIs...</div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card">
                <div class="chart-title">Claims Trend Over Time</div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Claim Status Distribution</div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Top 10 Providers by Approved Amount</div>
                <div class="chart-container">
                    <canvas id="providersChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Claims by Business Unit</div>
                <div class="chart-container">
                    <canvas id="buChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Age Distribution</div>
                <div class="chart-container">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Gender Distribution</div>
                <div class="chart-container">
                    <canvas id="genderChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Top Benefit Types by Count</div>
                <div class="chart-container">
                    <canvas id="benefitCountChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Top Benefit Types by Amount</div>
                <div class="chart-container">
                    <canvas id="benefitAmountChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Distribution Channels - Claims</div>
                <div class="chart-container">
                    <canvas id="channelChart"></canvas>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Yearly Comparison</div>
                <div class="chart-container">
                    <canvas id="yearlyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <div class="chart-title">üìã Claims Data</div>
            <div id="table-loading" class="loading">Loading data...</div>
            <div id="table-content" style="display: none;">
                <table id="claimsTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};
        let currentFilters = {};
        let currentPage = 1;

        // Initialize dashboard
        async function initDashboard() {
            await loadFilterOptions();
            await loadData();
            setupFilterListeners();
        }

        // Load filter options
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/pchi/filter-options');
                const options = await response.json();

                // Populate filters
                populateFilter('yearFilter', options.years || []);
                populateFilter('statusFilter', options.statuses || []);
                populateFilter('buFilter', options.business_units || []);
                populateFilter('productFilter', options.products || []);
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }

        function populateFilter(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = options.map(opt => 
                `<option value="${opt}" selected>${opt}</option>`
            ).join('');
        }

        function setupFilterListeners() {
            ['yearFilter', 'statusFilter', 'buFilter', 'productFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', handleFilterChange);
            });
        }

        function handleFilterChange() {
            currentFilters = {
                years: getSelectedValues('yearFilter').map(Number),
                statuses: getSelectedValues('statusFilter'),
                business_units: getSelectedValues('buFilter'),
                products: getSelectedValues('productFilter')
            };
            loadData();
        }

        function getSelectedValues(id) {
            const select = document.getElementById(id);
            return Array.from(select.selectedOptions).map(opt => opt.value);
        }

        // Load all data
        async function loadData() {
            await Promise.all([
                loadKPIs(),
                loadCharts(),
                loadTable()
            ]);
        }

        // Load KPIs
        async function loadKPIs() {
            try {
                const response = await fetch('/api/pchi/kpis', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filters: currentFilters})
                });
                const kpis = await response.json();

                document.getElementById('kpis-container').innerHTML = `
                    <div class="kpi-card">
                        <div class="kpi-label">Total Claims</div>
                        <div class="kpi-value">${kpis.total_claims.toLocaleString()}</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Total Incurred</div>
                        <div class="kpi-value">‡∏ø${(kpis.total_incurred / 1000000).toFixed(2)}M</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Total Approved</div>
                        <div class="kpi-value">‡∏ø${(kpis.total_approved / 1000000).toFixed(2)}M</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Total Claimed</div>
                        <div class="kpi-value">‡∏ø${(kpis.total_claimed / 1000000).toFixed(2)}M</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Approval Rate</div>
                        <div class="kpi-value">${kpis.approval_rate.toFixed(1)}%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Avg Claim Amount</div>
                        <div class="kpi-value">‡∏ø${kpis.avg_claim_amount.toLocaleString()}</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading KPIs:', error);
            }
        }

        // Load all charts
        async function loadCharts() {
            const endpoints = [
                {id: 'trends', chartId: 'trendChart', fn: renderTrendChart},
                {id: 'status', chartId: 'statusChart', fn: renderStatusChart},
                {id: 'providers', chartId: 'providersChart', fn: renderProvidersChart},
                {id: 'business-units', chartId: 'buChart', fn: renderBUChart},
                {id: 'age-distribution', chartId: 'ageChart', fn: renderAgeChart},
                {id: 'gender-distribution', chartId: 'genderChart', fn: renderGenderChart},
                {id: 'benefit-types', chartId: 'benefitCountChart', fn: renderBenefitCharts},
                {id: 'distribution-channels', chartId: 'channelChart', fn: renderChannelChart},
                {id: 'yearly-comparison', chartId: 'yearlyChart', fn: renderYearlyChart}
            ];

            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`/api/pchi/${endpoint.id}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({filters: currentFilters})
                    });
                    const data = await response.json();
                    endpoint.fn(data, endpoint.chartId);
                } catch (error) {
                    console.error(`Error loading ${endpoint.id}:`, error);
                }
            }
        }

        // Chart rendering functions
        function renderTrendChart(data, chartId) {
            destroyChart(chartId);
            const ctx = document.getElementById(chartId).getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Claim Count',
                        data: data.claim_counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y'
                    }, {
                        label: 'Approved Amount',
                        data: data.approved_amounts,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {intersect: false, mode: 'index'},
                    scales: {
                        y: {position: 'left', title: {display: true, text: 'Claim Count'}},
                        y1: {position: 'right', grid: {drawOnChartArea: false}, title: {display: true, text: 'Amount (‡∏ø)'}}
                    }
                }
            });
        }

        function renderStatusChart(data, chartId) {
            destroyChart(chartId);
            const ctx = document.getElementById(chartId).getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: ['#10b981', '#ef4444'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {position: 'bottom'}}
                }
            });
        }

        function renderProvidersChart(data, chartId) {
            destroyChart(chartId);
            const ctx = document.getElementById(chartId).getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Approved Amount',
                        data: data.values,
                        backgroundColor: '#667eea'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {display: false}}
                }
            });
        }

        function renderBUChart(data, chartId) {
            destroyChart(chartId);
            const ctx = document.getElementById(chartId).getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Claim Count',
                        data: data.claim_counts,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderAgeChart(data, chartId) {
            destroyChart(chartId);
            const ctx = document.getElementById(chartId).getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Claims',
                        data: data.values,
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderGenderChart(data, chartId) {
            destroyChart(chartId);
            const ctx = document.getElementById(chartId).getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: ['#ec4899', '#3b82f6']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {position: 'bottom'}}
                }
            });
        }

        function renderBenefitCharts(data, chartId) {
            // Render count chart
            destroyChart('benefitCountChart');
            const ctx1 = document.getElementById('benefitCountChart').getContext('2d');
            charts['benefitCountChart'] = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: data.by_count.labels,
                    datasets: [{
                        label: 'Claims',
                        data: data.by_count.values,
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {display: false}}
                }
            });

            // Render amount chart
            destroyChart('benefitAmountChart');
            const ctx2 = document.getElementById('benefitAmountChart').getContext('2d');
            charts['benefitAmountChart'] = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: data.by_amount.labels,
                    datasets: [{
                        label: 'Amount',
                        data: data.by_amount.values,
                        backgroundColor: '#8b5cf6'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {display: false}}
                }
            });
        }

        function renderChannelChart(data, chartId) {
            destroyChart(chartId);
            const ctx = document.getElementById(chartId).getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Claim Count',
                        data: data.claim_counts,
                        backgroundColor: '#06b6d4'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderYearlyChart(data, chartId) {
            destroyChart(chartId);
            const ctx = document.getElementById(chartId).getContext('2d');
            charts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Claims',
                        data: data.claim_counts,
                        backgroundColor: '#667eea'
                    }, {
                        label: 'Approved',
                        data: data.approved_amounts.map(v => v / 1000000),
                        backgroundColor: '#10b981',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {position: 'left', title: {display: true, text: 'Claims'}},
                        y1: {position: 'right', grid: {drawOnChartArea: false}, title: {display: true, text: 'Amount (M‡∏ø)'}}
                    }
                }
            });
        }

        function destroyChart(chartId) {
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
        }

        // Load table
        async function loadTable(page = 1) {
            try {
                const response = await fetch('/api/pchi/table', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filters: currentFilters, page, page_size: 50})
                });
                const tableData = await response.json();

                document.getElementById('table-loading').style.display = 'none';
                document.getElementById('table-content').style.display = 'block';

                // Render table headers
                document.getElementById('tableHead').innerHTML = '<tr>' + 
                    tableData.columns.map(col => `<th>${col}</th>`).join('') + '</tr>';

                // Render table body
                document.getElementById('tableBody').innerHTML = tableData.data
                    .map(row => '<tr>' + row.map(cell => `<td>${cell}</td>`).join('') + '</tr>')
                    .join('');

                // Render pagination
                renderPagination(tableData.page, tableData.total_pages);
            } catch (error) {
                console.error('Error loading table:', error);
            }
        }

        function renderPagination(currentPage, totalPages) {
            const pagination = document.getElementById('pagination');
            const pages = [];

            pages.push(`<button ${currentPage === 1 ? 'disabled' : ''} onclick="loadTable(${currentPage - 1})">Previous</button>`);

            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                pages.push(`<button class="${i === currentPage ? 'active' : ''}" onclick="loadTable(${i})">${i}</button>`);
            }

            pages.push(`<button ${currentPage === totalPages ? 'disabled' : ''} onclick="loadTable(${currentPage + 1})">Next</button>`);

            pagination.innerHTML = pages.join('');
        }

        function refreshDashboard() {
            loadData();
        }

        // Initialize on load
        window.addEventListener('load', initDashboard);
    </script>
</body>
</html>
